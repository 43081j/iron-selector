<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!--
`core-selector` is an element which can be used to manage a list of elements
that can be selected.

Example:

    <core-selector selected="0">
      <div>Item 1</div>
      <div>Item 2</div>
      <div>Item 3</div>
    </core-selector>

`core-selector` is not styled. Use the `core-selected` CSS class to style the selected element.

    <style>
      .core-selected {
        background: #eee;
      }
    </style>
    ...
    <core-selector selected="0>
      <div>Item 1</div>
      <div>Item 2</div>
      <div>Item 3</div>
    </core-selector>

@group Polymer Core Elements
@element core-selector
@homepage github.io
-->

<link rel="import" href="../polymer/polymer.html">

<script>

  Polymer({

    is: 'core-selector',

    published: {

      selected: {
        type: String,
        notify: true
      },

      item: {
        type: Object,
        readOnly: true,
        notify: true
      },

      activateEvent: String

    },

    bind: {
      selected: 'selectedChanged',
      item: 'itemChanged',
      activateEvent: 'activateEventChanged'
    },

    selectedClass: 'core-selected',

    selectedAttribute: '',

    excludedLocalNames: {
      'template': 1
    },

    configure: function() {
      this._activateListener = this.activateHandler.bind(this);
      this.observeItems();
      return {
        activateEvent: 'click'
      }
    },

    detached: function() {
      this.removeListener(this.activateEvent);
    },

    activateEventChanged: function(eventName, old) {
      this.removeListener(old);
      this.addListener(eventName);
    },

    addListener: function(eventName) {
      if (eventName) {
        this.addEventListener(eventName, this._activateListener);
      }
    },

    removeListener: function(eventName) {
      if (eventName) {
        this.removeEventListener(eventName, this._activateListener);
      }
    },

    selectedChanged: function(selected) {
      this._setItem(this.items[selected]);
    },

    itemChanged: function(item, old) {
      this.selected = this.items.indexOf(item);
      if (this.selectedAttribute) {
        this.attributeFollows(this.selectedAttribute, item, old);
      }
      if (this.selectedClass) {
        this.classFollows(this.selectedClass, item, old);
      }
    },

    /**
     * Returns an array of selectable items.
     *
     * @property items
     */
    get items() {
      if (!this._items) {
        var nodes;
        if (this.selectable) {
          nodes = this.querySelectorAll(this.selectable);
        } else {
          nodes = this.children;
        }
        this._items = Array.prototype.filter.call(nodes,
            this.filterItem.bind(this));
      }
      return this._items;
    },

    filterItem: function(node) {
      return node.localName && !this.excludedLocalNames[node.localName];
    },

    observeItems: function() {
      var observation = function() {
        this.updateItems();
      }.bind(this);
      var observer = new MutationObserver(observation);
      observer.observe(this, {
        childList: true,
        subtree: true
      });
    },

    updateItems: function() {
      this._items = null;
      if (this.selected >= 0) {
        this._selectedEffector();
      }
    },

    activateHandler: function(e) {
      var t = e.target;
      var items = this.items;
      while (t && t != this) {
        var i = Array.prototype.indexOf.call(items, t);
        if (i >= 0) {
          if (!this.fire('core-activate', null, t).defaultPrevented) {
            this._setItem(t);
          }
          return;
        }
        t = t.parentNode;
      }
    },

    /**
     * Selects the previous item.
     *
     * @method selectPrevious
     */
    selectPrevious: function() {
      this.selected =
        (Number(this.index) - 1 + this.items.length) % this.items.length;
    },

    /**
     * Selects the next item.
     *
     * @method selectNext
     */
    selectNext: function() {
      this.selected = (Number(this.index) + 1) % this.items.length;
    }

  });

</script>
